generator client {
  provider = "prisma-client"
  output   = "../src/app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Wizard {
  id              String         @id
  fullName        String
  email           String         @unique
  avatarUrl       String?
  phoneNumber     String?
  linkedinUrl     String?
  instagramUrl    String?
  karmaScore      Int            @default(0)
  karmaRank       KarmaRank      @default(MUGGLE)
  role            UserRole       @default(USER)
  isBanished      Boolean        @default(false)
  lastLoginDate   DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime
  cursedObjects   CursedObject[]
  bloodPacts      BloodPact[]
  lostRelics      LostRelic[]
  claimedRelics   LostRelic[]    @relation("ClaimedRelics")
  chatRooms       ChatRoom[]
  messages        Message[]
  notifications   Notification[]
  purchases       Transaction[]  @relation("BuyerTransactions")
  sales           Transaction[]  @relation("SellerTransactions")
  ratingsGiven    Rating[]       @relation("RatingsGiven")
  ratingsReceived Rating[]       @relation("RatingsReceived")
  offerActions    OfferHistory[]
}

model CursedObject {
  id          String     @id @default(cuid())
  sellerId    String
  seller      Wizard     @relation(fields: [sellerId], references: [id])
  title       String
  description String
  images      String[]
  price       Float
  condition   String
  status      ItemStatus @default(ACTIVE)
  category    String

  offers       BloodPact[]
  chatRooms    ChatRoom[]
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BloodPact {
  id                 String       @id @default(cuid())
  itemId             String
  item               CursedObject @relation(fields: [itemId], references: [id])
  buyerId            String
  buyer              Wizard       @relation(fields: [buyerId], references: [id])
  offerAmount        Float
  counterOfferAmount Float?
  status             OfferStatus  @default(PENDING)
  expiresAt          DateTime?
  deliveredAt        DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  history OfferHistory[]
}

model OfferHistory {
  id      String    @id @default(cuid())
  offerId String
  offer   BloodPact @relation(fields: [offerId], references: [id], onDelete: Cascade)

  action    OfferAction
  amount    Float?
  createdAt DateTime    @default(now())
  actorId   String
  actor     Wizard      @relation(fields: [actorId], references: [id])
}

enum OfferAction {
  CREATED
  COUNTERED
  ACCEPTED
  REJECTED
  CANCELLED
  REVIVED
  EXPIRED
}

model LostRelic {
  id         String @id @default(cuid())
  reporterId String
  reporter   Wizard @relation(fields: [reporterId], references: [id])

  title             String
  description       String
  images            String[]
  location          String?
  type              RelicType
  status            RelicStatus @default(OPEN)
  secretRiddle      String?
  hiddenTruth       String?
  claimerId         String?
  claimer           Wizard?     @relation("ClaimedRelics", fields: [claimerId], references: [id])
  claimerVerifiedAt DateTime?
  droppedOffAt      DateTime?
  deliveredAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chatRooms ChatRoom[]
}

model ChatRoom {
  id            String        @id @default(cuid())
  relicId       String?
  relic         CursedObject? @relation(fields: [relicId], references: [id])
  lostRelicId   String?
  lostRelic     LostRelic?    @relation(fields: [lostRelicId], references: [id])
  participants  Wizard[]
  messages      Message[]
  lastMessageAt DateTime      @default(now())
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Message {
  id         String      @id @default(cuid())
  chatRoomId String
  chatRoom   ChatRoom    @relation(fields: [chatRoomId], references: [id])
  senderId   String
  sender     Wizard      @relation(fields: [senderId], references: [id])
  content    String
  type       MessageType @default(TEXT)
  isRead     Boolean     @default(false)
  createdAt  DateTime    @default(now())
}

model Notification {
  id          String           @id @default(cuid())
  userId      String
  user        Wizard           @relation(fields: [userId], references: [id])
  type        NotificationType
  referenceId String
  isSeen      Boolean          @default(false)
  createdAt   DateTime         @default(now())
}

model Transaction {
  id          String       @id @default(cuid())
  buyerId     String
  buyer       Wizard       @relation("BuyerTransactions", fields: [buyerId], references: [id])
  sellerId    String
  seller      Wizard       @relation("SellerTransactions", fields: [sellerId], references: [id])
  relicId     String
  relic       CursedObject @relation(fields: [relicId], references: [id])
  finalPrice  Float
  completedAt DateTime     @default(now())
  rating      Rating?
}

model Rating {
  id            String      @id @default(cuid())
  transactionId String      @unique
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  raterId       String
  rater         Wizard      @relation("RatingsGiven", fields: [raterId], references: [id])
  sellerId      String
  seller        Wizard      @relation("RatingsReceived", fields: [sellerId], references: [id])
  stars         Int
  comment       String?
  createdAt     DateTime    @default(now())
}

enum MessageType {
  TEXT
  OFFER
  COUNTER_OFFER
  SYSTEM
}

enum NotificationType {
  OFFER_RECEIVED
  OFFER_ACCEPTED
  OFFER_REJECTED
  OFFER_COUNTERED
  MESSAGE_RECEIVED
  ITEM_SOLD
  RATING_RECEIVED
  KARMA_EARNED
  RELIC_MATCH
}

enum KarmaRank {
  MUGGLE
  WIZARD
  AUROR
  DARK_KNIGHT
}

enum UserRole {
  USER
  ADMIN
}

enum ItemStatus {
  ACTIVE
  RESERVED
  SOLD
}

enum OfferStatus {
  PENDING
  COUNTER_OFFER_PENDING
  ACCEPTED
  REJECTED
  EXPIRED
  CANCELLED
  AWAITING_COMPLETION
  DELIVERED
  COMPLETED
}

enum RelicType {
  LOST
  FOUND
}

enum RelicStatus {
  OPEN
  VERIFIED
  PENDING_PICKUP
  DROPPED_OFF
  DELIVERED
  SOLVED
}
